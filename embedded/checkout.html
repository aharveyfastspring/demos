<html>

<head>

    <!-- FastSpring Header -->
    <script id="fsc-api" src="https://d1f8f9xcsvx3ha.cloudfront.net/sbl/0.8.7/fastspring-builder.min.js"
        type="text/javascript" data-storefront="aharvey.test.onfastspring.com/embedded-demo"
        data-data-callback="dataCallback" data-continuous="true"
        data-before-requests-callback="beforeRequestsCallbackFunction"
        data-after-markup-callback="afterMarkupCallbackFunction">
        </script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
    <!-- CSS -->
    <link rel="stylesheet" href="./demo.css">

    <title>FastSpring Embedded Checkout Demo</title>

</head>

<body>
    <h1>FastSpring</h1>
    <h2>Embedded Checkout Demo 2022</h2>

    <div class="demo-header">
        <div class="demo-header-row">
            <a href="#" class="collapsible">Click here for demo information</a>
        </div>
        <div class="demo-header-collapsible" id="demo-header-collapsible">
            <div class="demo-header-col">
                <div class="demo-header-item">Card Number: <span class="testdetails">4242 4242 4242 4242</span></div>
                <div class="break"></div>
                <div class="demo-header-item">Expiry Date: <span class="testdetails">Any date in the future</span></div>
                <div class="break"></div>
                <div class="demo-header-item">CVV: <span class="testdetails">*HFBB</span></div>
                <div class="break"></div>
                <div class="demo-header-item">Coupon Code: <span class="testdetails">20OFF</span></div>
                <div class="break"></div>
                <!-- Link to reset the demo -->
                <div class="demo-header-item"><a class="reset" href="#" onclick="resetDemo()">[Reset Demo]</a></div>
            </div>
            <div class="demo-header-col"> <img src="./images/info.png" class="infoImage"></img></div>
        </div>
    </div>

    <!-- Main page content container -->
    <div class="flex_container">

        <!-- Left side of the page: order summary and review -->
        <div class="flex_item_left">
            <div class="cartTitle">
                <!-- Order Summary title bar -->
                <h3>
                    <img src="./images/shopping_cart.png" class="cartImageCheckout"></img>
                    Order Summary
                </h3>
            </div>
            <!-- Shopping Cart -->
            <p>
            <div id="cartContents"></div>
            </p>

            <!-- Coupon code input fields -->
            <div class="couponCode">
                <input class="couponInput" id="couponInput" type="text" data-fsc-promocode-value
                    placeholder="Coupon Code" />
                <button class="applyCoupon" id="applyCoupon" data-fsc-action="Promocode">
                    Apply Coupon
                </button>
            </div>
        </div>

        <!-- Right side of the page - FastSpring checkout -->
        <div class="flex_item_right">

            <!-- Load the FastSpring Embedded Checkout -->
            <div id="fsc-embedded-checkout-container"></div>

        </div>
    </div>

    <!--
		Spinner to display action taking place.
		-->
    <div id="fastspring_spinner">
        <img src="https://d1f8f9xcsvx3ha.cloudfront.net/pinhole/spin.svg" />
    </div>

</body>


<script>

    var coll = document.getElementsByClassName("collapsible");
    var i;

    for (i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function () {
            this.classList.toggle("active");
            var content = document.getElementById("demo-header-collapsible");
            if (content.style.maxHeight) {
                content.style.marginTop = "0px";
                content.style.maxHeight = null;
            } else {
                content.style.marginTop = "20px";
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    }

    function dataCallback(data) {

        /* This function is called every time there is a callback from the FastSpring server.
        The callback contains a JSON payload - data - that contains all information about the current order */

        // Reset and clear the cart contents area of the page
        cartContents.innerHTML = '';

        // Loop over the order session to retreive and display the contents
        if (data && data.hasOwnProperty('groups')) {
            const {
                groups
            } = data;
            groups.forEach(group => {
                if (group.items && Array.isArray(group.items)) {
                    group.items.forEach(item => {

                        if (item.selected) {

                            var itemPath = item.path;

                            // Product name and quantity
                            var cartItemListing = document.createElement("div");

                            // Product Name
                            var itemNameSpan = document.createElement("span");
                            itemNameSpan.className = "cartProductName";
                            var productName = document.createTextNode(item.display);
                            itemNameSpan.appendChild(productName);

                            // Item Quantity

                            var quantitySpan = document.createElement("span");
                            quantitySpan.className = "quantity buttons_added";

                            var itemQuantityID = item.path + "-quantity";

                            // Decrease quantity by 1
                            var minusButton = document.createElement("input");
                            minusButton.id = itemQuantityID + "decrement";
                            minusButton.type = "button";
                            minusButton.className = "minus";
                            minusButton.value = "-";

                            // Quantity input field
                            var itemQuantityInput = document.createElement("input");
                            itemQuantityInput.id = itemQuantityID;
                            itemQuantityInput.className = "input-text qty text";
                            itemQuantityInput.size = 4;
                            itemQuantityInput.value = item.quantity;

                            // Increase quantity by 1
                            var plusButton = document.createElement("input");
                            plusButton.id = itemQuantityID + "increment";
                            plusButton.type = "button";
                            plusButton.className = "plus";
                            plusButton.value = "+";

                            quantitySpan.appendChild(minusButton);
                            quantitySpan.appendChild(itemQuantityInput);
                            quantitySpan.appendChild(plusButton);

                            // Remove item from order button
                            var removeItem = document.createElement("i");
                            removeItem.className = "bi bi-x-circle remove";
                            removeItem.onclick = function () { fastspring.builder.remove(itemPath); };

                            // Write these details to the DOMâˆ‚
                            cartItemListing.appendChild(itemNameSpan);
                            cartItemListing.appendChild(quantitySpan);
                            cartItemListing.appendChild(removeItem);

                            var cartContentsElement = document.getElementById("cartContents");
                            cartContentsElement.appendChild(cartItemListing);


                            // Add event listeners for quantity selection
                            document.getElementById(itemQuantityID).addEventListener("change", function () {
                                fastspring.builder.update(item.path, document.getElementById(itemQuantityID).value);
                            });

                            document.getElementById(itemQuantityID + "increment").addEventListener("click", function () {
                                fastspring.builder.update(item.path, parseInt(document.getElementById(itemQuantityID).value) + 1);
                            });

                            document.getElementById(itemQuantityID + "decrement").addEventListener("click", function () {
                                fastspring.builder.update(item.path, parseInt(document.getElementById(itemQuantityID).value) - 1);
                            });

                            // Item total

                            if (item.discountTotalValue > 0) {
                                // Discounted price display

                                var discountDisplay = document.createElement("div");

                                // Original amount with strikethrough
                                var originalPriceSpan = document.createElement("span");
                                originalPriceSpan.className = "cartItemTotalOriginalPrice";
                                var itemTotalOriginal = document.createTextNode(item.priceTotal);
                                originalPriceSpan.appendChild(itemTotalOriginal);

                                // New amount after discount
                                var newPriceSpan = document.createElement("span");
                                newPriceSpan.className = "cartItemTotal";
                                var itemTotal = document.createTextNode(" " + item.total);
                                newPriceSpan.appendChild(itemTotal);

                                discountDisplay.appendChild(originalPriceSpan);
                                discountDisplay.appendChild(newPriceSpan);

                                var cartContentsElement = document.getElementById("cartContents");
                                cartContentsElement.appendChild(discountDisplay);

                            } else {
                                // No discount
                                var itemTotalTag = document.createElement("div");
                                itemTotalTag.className = "cartItemTotal";
                                var itemTotal = document.createTextNode(item.total);
                                itemTotalTag.appendChild(itemTotal);
                                var cartContentsElement = document.getElementById("cartContents");
                                cartContentsElement.appendChild(itemTotalTag);
                            }

                            // New Line
                            var brTag = document.createElement("br");
                            var cartContentsElement = document.getElementById("cartContents");
                            cartContentsElement.appendChild(brTag);

                        }
                    });
                }
            });

            // Order total

            if (data.discountTotalValue > 0) {
                // Discounted Display

                var summaryBox = document.createElement("div");
                summaryBox.className = "summaryBox";

                var orderTotalTag = document.createElement("div");

                // Order Total Description
                var orderTotalTitleSpan = document.createElement("span");
                orderTotalTitleSpan.className = "orderTotal";
                var orderTotalTitle = document.createTextNode("Order Total: ");
                orderTotalTitleSpan.appendChild(orderTotalTitle);

                // Original amount with strikethrough
                var originalTotalSpan = document.createElement("span");
                originalTotalSpan.className = "orderTotalOriginal";
                var orderTotalOriginal = document.createTextNode(data.originalTotal);
                originalTotalSpan.appendChild(orderTotalOriginal);

                // New amount after discount
                var originalTotalDiscountedSpan = document.createElement("span");
                originalTotalDiscountedSpan.className = "orderTotal";
                var orderTotalDiscountedAmount = document.createTextNode(" " + data.total);
                originalTotalDiscountedSpan.appendChild(orderTotalDiscountedAmount);

                summaryBox.appendChild(orderTotalTitleSpan);
                summaryBox.appendChild(originalTotalSpan);
                summaryBox.appendChild(originalTotalDiscountedSpan);


                // Discount information
                var discountPercentageTag = document.createElement("div");
                discountPercentageTag.className = "discountSavings";
                var discountPercentage = document.createTextNode("You save " + data.discountTotalPercent + "!");
                discountPercentageTag.appendChild(discountPercentage);
                summaryBox.appendChild(discountPercentageTag);

                // Tax
                var taxTag = document.createElement("div");
                taxTag.className = "cartItemTotal";
                var taxDetails = document.createTextNode("Including " + data.taxType + ": " + data.tax + " (" + data.taxRate + ")");
                taxTag.appendChild(taxDetails);
                summaryBox.appendChild(taxTag);

                var cartContentsElement = document.getElementById("cartContents");
                cartContentsElement.appendChild(summaryBox);


                // Hide coupon field
                var couponInputField = document.getElementById("couponInput");
                couponInputField.style.display = "none";

                var couponButton = document.getElementById("applyCoupon");
                couponButton.style.display = "none";


            } else {
                // No discount
                var summaryBox = document.createElement("div");
                summaryBox.className = "summaryBox";

                var orderTotalTag = document.createElement("div");
                orderTotalTag.className = "orderTotal";
                var orderTotal = document.createTextNode("Order Total: " + data.total);
                orderTotalTag.appendChild(orderTotal);
                summaryBox.appendChild(orderTotalTag);

                // Tax
                var taxTag = document.createElement("div");
                taxTag.className = "cartItemTotal";
                var taxDetails = document.createTextNode("Including " + data.taxType + ": " + data.tax + " (" + data.taxRate + ")");
                taxTag.appendChild(taxDetails);
                summaryBox.appendChild(taxTag);

                var cartContentsElement = document.getElementById("cartContents");
                cartContentsElement.appendChild(summaryBox);
            }


        }
    }

    function resetDemo() {
        // Clear the current order session and redirect back to the original page
        fastspring.builder.reset();
        window.location.replace("./index.html");
    }

    function beforeRequestsCallbackFunction() {
        var fsb_spinner = document.getElementById("fastspring_spinner");
        fsb_spinner.style.display = "block";
    }

    function afterMarkupCallbackFunction() {
        var fsb_spinner = document.getElementById("fastspring_spinner");
        fsb_spinner.style.animationName = "fsb-revfadeIn";
        setTimeout(function () {
            fsb_spinner.style.animationName = "fsb-fadeIn";
            fsb_spinner.style.display = "none";
        }, 450);
    }

</script>

</html>
